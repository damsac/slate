---
status: committed
goal: "Add Nix-based reproducible dev environment with git hooks, per-developer config, and Makefile workflows"
author: gudnuf
project: Slate
tags: [nix, devshell, xcodegen, git-hooks, dx, infrastructure]
conversation_id: ""
commit_hash: "5c4eb8e"
created: "2026-02-08T23:52:11Z"
---

# Nix-based reproducible dev environment with git hooks

## Human Prompt

Second dev is joining. I want a reproducible dev setup so they just need Nix + Xcode — `direnv allow && make generate` gets them building. Specifically:

- Nix flake with pinned xcodegen, swiftlint, xcbeautify, gnumake
- direnv `.envrc` for auto-activation
- Move `DEVELOPMENT_TEAM` out of `project.yml` into a per-developer gitignored file using XcodeGen includes
- Makefile with generate (must validate entitlements), build, lint, clean, help
- Stop committing `Slate.xcodeproj` — regenerate from `project.yml`
- Git hooks: pre-commit validates entitlements + lints Swift, post-merge regenerates project after pull
- Update all docs: setup skill (Nix-based onboarding), README, CLAUDE.md, TODO.md
- Setup skill should end with tips including a prompt to fix the "untrusted substituter" Nix warning

## Agent Prompt

Implement a Nix-based reproducible dev environment for the Slate iOS project. A second developer is joining — the goal is `direnv allow && make generate` from a fresh clone.

**New files:**
1. `flake.nix` — devShell for `aarch64-darwin` with `xcodegen`, `swiftlint`, `xcbeautify`, `gnumake`. Define `pre-commit` and `post-merge` hooks as `pkgs.writeShellScript` Nix store scripts. shellHook symlinks them into `.git/hooks/`. Pre-commit: if `project.yml` staged, run xcodegen + validate both `.entitlements` contain `group.com.damsac.slate.shared`; run swiftlint `--strict` on staged `.swift` files. Post-merge: if `project.yml` changed, `make generate`; if `flake.nix`/`flake.lock` changed, print `direnv reload` reminder. Use absolute Nix store paths in hooks so they work outside the devShell.
2. `.envrc` — `use flake`
3. `project.local.yml.template` — `DEVELOPMENT_TEAM: YOUR_TEAM_ID_HERE`
4. `Makefile` — `generate` target: `touch project.local.yml` if missing (XcodeGen has no optional include), run `xcodegen generate`, validate both entitlements files. `build`: simulator build with `CODE_SIGN_IDENTITY=-` piped through xcbeautify. `lint`: swiftlint on both source dirs. `clean`: xcodebuild clean + rm artifacts. `help`: self-documenting via grep.

**Modified files:**
5. `project.yml` — add `include: - path: project.local.yml` (not optional — Makefile ensures file exists). Remove hardcoded `DEVELOPMENT_TEAM: 733QG5V76U`.
6. `.gitignore` — add `Slate.xcodeproj/`, `project.local.yml`, `.direnv/`, `result`. Then `git rm -r --cached Slate.xcodeproj/`.
7. `.claude/skills/setup/SKILL.md` — Phase 1: Nix+direnv instead of Homebrew. New Phase 2: `direnv allow`, verify tools on PATH. Phase 4: `make generate` + `make build`. Phase 5b: `cp project.local.yml.template project.local.yml` workflow. Fix `group.com.slate.shared` → `group.com.damsac.slate.shared`. New Tips section: explain auto-installed hooks; include a copy-paste prompt for fixing "untrusted substituter" warnings.
8. `README.md` — Prerequisites: Xcode+Nix+direnv. Setup: `direnv allow` → `make generate`. Make targets table. Device setup via template.
9. `CLAUDE.md` — New "Dev Environment" section with key files table, rules (always `make generate`, never hardcode team ID, never commit xcodeproj). Document git hooks.
10. `TODO.md` — Mark done: configure dev team, move DEVELOPMENT_TEAM to per-dev config.

**Verify:** `nix flake check`, `nix develop --command which xcodegen swiftlint xcbeautify make`, `make generate`, `make help`. Confirm hooks symlinked after shell entry.

## Result

Delivered as planned. 14 files changed (6 new, 5 modified, 3 deleted from index). One deviation: XcodeGen doesn't support `optional: true` on includes — used Makefile `touch` to create empty `project.local.yml` if missing instead. Pre-commit hook validated entitlements on the commit itself. README was further refined by the developer to lead with "How We Work" section focused on Claude Code as the primary dev interface.
